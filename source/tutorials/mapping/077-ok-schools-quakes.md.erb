---
title: Oklahoma earthquakes and schools and CartoDB Spatial Joins
listed: true
references: 
  - title: Learning SQL through the CartoDB Editor
    url: http://academy.cartodb.com/courses/sql-postgis/intro-to-sql-and-postgis/
    description: A video tutorial on basic SQL in CartoDB
  - title: PostGIS in CartoDB
    url: http://academy.cartodb.com/courses/sql-postgis/postgis-in-cartodb/
    description: |
      via the CartoDB summary text: "This lesson introduces several commonly used functions in PostGIS with the goal of extending your geospatial analysis of data within CartoDB and show you some of the analysis you can do with your geospatial data."
---


[USGS official map of M4.5+ earthquakes around Oklahoma](http://earthquake.usgs.gov/earthquakes/map/#%7B%22feed%22%3A%221449549499693%22%2C%22sort%22%3A%22newest%22%2C%22mapposition%22%3A%5B%5B33.472%2C-103.074%5D%2C%5B37.058%2C-94.241%5D%5D%2C%22viewModes%22%3A%7B%22help%22%3Afalse%2C%22list%22%3Atrue%2C%22map%22%3Atrue%2C%22settings%22%3Afalse%7D%2C%22autoUpdate%22%3Afalse%2C%22search%22%3A%7B%22id%22%3A%221449549499693%22%2C%22name%22%3A%22Search%20Results%22%2C%22isSearch%22%3Atrue%2C%22params%22%3A%7B%22starttime%22%3A%222008-11-30%2000%3A00%3A00%22%2C%22maxlatitude%22%3A37.058%2C%22minlatitude%22%3A33.472%2C%22maxlongitude%22%3A-94.241%2C%22minlongitude%22%3A-103.074%2C%22minmagnitude%22%3A4.5%2C%22eventtype%22%3A%22earthquake%22%2C%22endtime%22%3A%222015-12-07%2023%3A59%3A59%22%2C%22orderby%22%3A%22time%22%7D%7D%7D)

![image usgs-map-of-M45-quakes-near-ok.png](/files/images/tutorials/cartodb/usgs-map-of-M45-quakes-near-ok.png)



# Filter and display some dots

As always, we start with the simplest way to get things to show up on a map. Let's show _all_ (6,000+) of the earthquake points:

~~~sql
SELECT *
FROM ok_quakes;
~~~


![image ok_quakes_all_of_em.png](/files/images/tutorials/cartodb/ok_quakes_all_of_em.png)



## First, show the "big" earthquakes

It's a cool visual, but it has about __zero__ actual information value to those who aren't impressed with seeing a bunch of dots. So let's filter for just the _major_ earthquakes.


### What kind of quakes does Oklahoma normally have?

Well, how do we define "normal"? Not just for Oklahoma and earthquakes, but for anything in life? I honestly don't know. And honestly, I don't have the attention span to think about it while I'm trying to figure out SQL and spreadsheets.

So I'm just going to get a __group count__ of all the earthquakes, according to _groups_ of their __magnitude__, rounded to the nearest __integer__:



~~~sql
SELECT 
  ROUND(mag) AS rounded_mag,
  COUNT(*)
FROM ok_quakes
GROUP BY rounded_mag
ORDER by rounded_mag;
~~~

![image ok_quakes_histogram_mag.png](/files/images/tutorials/cartodb/ok_quakes_histogram_mag.png)


(Note: why do I convert `mag`, a column that is already a number, to `numeric`? I don't know enough about [PostgreSQL's number types](http://www.postgresql.org/docs/8.1/static/functions-math.html) but without that conversion, I was getting an error when trying to call the `ROUND` function with 2 arguments. So, this works for now...)

~~~sql
SELECT 
  ROUND(mag::numeric, 2) AS rounded_mag,
  COUNT(*)
FROM ok_quakes
WHERE mag >= 4.0
GROUP BY rounded_mag
ORDER by rounded_mag;
~~~


![image ok_quakes_histogram_mag_tenths.png](/files/images/tutorials/cartodb/ok_quakes_histogram_mag_tenths.png)

Just to keep things visually simple, I think we can define "major" earthquakes to be of at least __M4.5__. That means we can expect to see `8` earthquake points on the map:

~~~sql
SELECT *
FROM ok_quakes
WHERE mag >= 4.5;
~~~

![image ok_quakes_4-5-above.png](/files/images/tutorials/cartodb/ok_quakes_4-5-above.png)





### Trim and specify the fields we SELECT

And now, be less lazy and select only the fields we need:

~~~sql
SELECT
  ok_quakes.cartodb_id,
  ok_quakes.the_geom_webmercator
FROM ok_quakes
WHERE mag >= 4.5;
~~~

The map view won't change -- though there will be no earthquake-specific data (e.g. specific magnitude or dates) since we've left out those columns:

![image ok_quakes_4-5-above-no-detail.png](/files/images/tutorials/cartodb/ok_quakes_4-5-above-no-detail.png)

-----------


# Boundaries

You may have noticed that at least one of our __M4.5+__ earthquakes is not actually within Oklahoma's boundaries:

![image ok_quakes_4-5-above-no-detail.png](/files/images/tutorials/cartodb/ok_quakes_4-5-above-no-detail.png)

Or maybe you didn't. Because you aren't even able to pick Oklahoma from a state map. And the contrast of the map tiles, in which state lines are _not_ emphasized, isn't making it any easier.


So let's start our geospatial-querying with the very limited goal of just making the darn state of Oklahoma actually visible to normal-sighted human beings. 

## Adding a layer of county boundaries

Note: In this section, I talk about using the [__Add Layer__ feature of CartoDB](http://docs.cartodb.com/tutorials/multilayer_overview/). This has _nothing_ to do with SQL or geospatial analysis. It is simply a CartoDB-specific feature for their [interactive maps](http://docs.cartodb.com/tutorials/multilayer_overview/), to allow casual users to add multiple layers of visual imagery onto a map without doing any type of logical SQL joining.

I use the __Add Layer__ feature here just to remind you what shapefiles look like when rendered on a map, that's all. And also, that there's a difference between what we _see_, and what we tell the computer to _geospatially filter_.

After uploading the Oklahoma county boundaries -- [which can be found at this URL](http://geo.ou.edu/oeb/Statewide/COUNTY.zip) -- as a __new dataset__, I can go back to whatever map I was using to show the `M4.5` earthquakes.

In the sidepanel, I click on the top panel labeled __Add layer__

![image ok-add-new-layer.png](/files/images/tutorials/cartodb/ok-add-new-layer.png)

This will prompt me to create an actual map -- (but aren't we already on a map? Well, not technically -- and yes, that will seem confusing...):

![image a-map-is-required-to-create-layers.png](/files/images/tutorials/cartodb/a-map-is-required-to-create-layers.png){:.bordered}

Anyway, after creating a new map, I'm presented with my list of datasets, from which I add the Oklahoma county shapefiles. And here's the result:

![image ok-new-map-layer-counties.png](/files/images/tutorials/cartodb/ok-new-map-layer-counties.png)

OK, we've accomplished our goal: we can clearly see that one earthquake that is _north_ of Oklahoma. Now, let's __filter__ it out with SQL.

(At this point, I can just remove the counties layer...it was just a visual thing anyway...but I leave it in the following examples as a visual reference point)


## Geo-filtering with ST_WITHIN

Let's actually take a step back and think of the _pseudo-code_ -- i.e. the plain English steps of what we intend to do:

> Show only the earthquakes in which the latitude and longitude are _inside_ -- i.e. __within__-- the boundaries of the __state__ of Oklahoma.

Actually, we don't have the state boundaries, and I don't feel like looking up a new shapefile to download. But we can still use the _counties_ shapefile to the same effect:

> Show only the earthquakes in which the latitude and longitude are within any of the boundaries of Oklahoma's _counties_.

It's computationally different, but the effect is the same. Now let's think about the query. We can basically think of it as an `INNER JOIN` with the `ok_counties` dataset/table, with some kind of function/conditional statement in the constraint:

~~~sql
SELECT
  ok_quakes.cartodb_id,
  ok_quakes.the_geom_webmercator
FROM ok_quakes
INNER JOIN ok_counties
  ON SOMETHING_SOMETHING_SOMETHING
WHERE mag >= 4.5;
~~~


What is that `SOMETHING_SOMETHING_SOMETHING`? Well, just a placeholder for now, while we figure out the name of the geospatial function will do the job that we've described in pseudocode.

### The ST_WITHIN geospatial function

It's worth reading more CartoDB tutorials for the bigger picture; for example, this [example uses a function named __ST_INTERSECTS__](http://academy.cartodb.com/courses/sql-postgis/joining-data/#join-two-tables-by-geospatial-intersection).

For our purposes, the function [__ST_WITHIN__](http://postgis.net/docs/ST_Within.html) will serve the same purpose. This is how it's described:

> `boolean ST_Within(geometry A, geometry B);` -- Returns true if the geometry __A__ is completely inside geometry __B__

Whatever. But at least we can see that it returns `true` -- which is something we need a function to do when doing a `JOIN`. What is `geometry A` -- i.e. what are the names of the columns in our __ok_quakes__ and __ok_counties__ tables?

These are things related to CartoDB's specific operation. Go ahead and skim through their tutorial titled __[Geospatial Analysis](http://docs.cartodb.com/tips-and-tricks/geospatial-analysis/)__.

Then see if the following query makes sense to you (if not, re-read the tutorial, repeat, etc.):

~~~sql
SELECT
  ok_quakes.cartodb_id,
  ok_quakes.the_geom_webmercator
FROM ok_quakes
INNER JOIN ok_counties
  ON ST_WITHIN(ok_quakes.the_geom, ok_counties.the_geom)
WHERE mag >= 4.5;
~~~

Begone Kansas quake:

![image ok-county-join-quakesst-within.png](/files/images/tutorials/cartodb/ok-county-join-quakesst-within.png)

And thus, we've successfully told CartoDB, via SQL, how to filter geospatial data based on _logic and math_.

As you can see, we had to learn a new function -- `ST_WITHIN` -- but we used the basic SQL concepts we've used plenty of times before.


# Census population

Showing _where_ big earthquakes have happened in Oklahoma is not particularly newsworthy. To paraphrase one of those websites with Zen quotes, if a big earthquake happens and there's nothing to shake, did it really happen?

In other words, big earthquakes in unpopulated areas -- for which there might be substantial quantities of in Oklahoma -- aren't particularly newsworthy. So let's get some population data via the [U.S. Census's Download Center](http://factfinder.census.gov/faces/nav/jsf/pages/download_center.xhtml):

![image ok-census-tracts-form.png](/files/images/tutorials/cartodb/ok-census-tracts-form.png)


## By county


~~~sql
SELECT
  ok_counties.cartodb_id,
  ok_counties.the_geom_webmercator,
  ok_county_pop.population_estimate_as_of_july_1___2014 
    AS pop2014
FROM ok_counties
INNER JOIN ok_county_pop
  ON 
    (ok_counties.state * 1000) + ok_counties.county = 
    ok_county_pop.id2;
~~~


![image ok-count-pop-by-county.png](/files/images/tutorials/cartodb/ok-count-pop-by-county.png)


## Census tracts


https://www.census.gov/geo/maps-data/data/kml/kml_tracts.html

~~~sql
SELECT 
  ok_tracts.cartodb_id,
  ok_tracts.the_geom_webmercator,
  ok_pop_2000.total AS total_pop
FROM 
   ok_tracts
INNER JOIN ok_pop_2000
    ON ok_pop_2000.id = ok_tracts.affgeoid
~~~


![image ok-count-pop-by-tract.png](/files/images/tutorials/cartodb/ok-count-pop-by-tract.png)




There's no need to join the `ok_county_pop` table to the `ok_quakes` table -- we can simply add the population choropleth as a __new layer__, so that we can see where the big earthquakes fall in relation to the population centers:

~~~sql
SELECT
  ok_quakes.*
FROM ok_quakes
INNER JOIN ok_counties
  ON ST_WITHIN(ok_quakes.the_geom, ok_counties.the_geom)
WHERE mag >= 4.5;
~~~

Unfortunately, it looks like the big earthquakes are near some of Oklahoma's most population-dense centers.


# Adding schools

http://nces.ed.gov/ccd/pubschuniv.asp

~~~sh
csvgrep -c LSTATE -m OK -t sc131a_supp.txt | 
  csvcut -c SURVYEAR,NCESSCH,LEANM,SCHNAM,LCITY,LSTATE,LZIP,TYPE,STATUS,LATCOD,LONCOD,GSLO,GSHI,LEVEL,TITLEISTAT,TITLEI,CHARTR,FRELCH,REDLCH,TOTFRL,MEMBER,VIRTUALSTAT \
  >  ok_schools_directory.csv
~~~

~~~sql
ALTER TABLE ok_schools_directory
ADD COLUMN pct_free_reduced_lunch FLOAT;

UPDATE ok_schools_directory
SET pct_free_reduced_lunch = ROUND(TOTFRL * 100 / MEMBER);


SELECT
  ok_schools_directory.*
FROM ok_schools_directory

INNER JOIN ok_quakes
ON ST_WITHIN(ok_schools_directory.the_geom,

             
        ST_Buffer(ok_quakes.the_geom::geography, 1609 * 10)::geometry)
             
            

WHERE mag >= 4.5
~~~


Or:


http://postgis.net/docs/manual-dev/ST_DWithin.html

~~~sql

SELECT * 
FROM ok_schools_directory
WHERE NCESSCH IN
(SELECT DISTINCT(NCESSCH)
FROM ok_schools_directory
INNER JOIN ok_quakes
ON ST_DWithin(ok_quakes.the_geom_webmercator, ok_schools_directory.the_geom_webmercator, 32000)
 AND ok_quakes.mag >= 4.5)          
          
~~~


# Drawing some "buffered" dots

TKTK

Let's start with the __ST_BUFFER__ function , which 


##


http://docs.cartodb.com/tips-and-tricks/geospatial-analysis/

~~~sql
SELECT
  cartodb_id,
  ST_Transform(
        ST_Buffer(the_geom::geography, 1609 * 10)::geometry, 
                  3857) AS the_geom_webmercator
FROM ok_quakes
WHERE mag >= 4.5;

# adding median layer
SELECT 
  ok_tracts.cartodb_id,
  ok_tracts.the_geom_webmercator,
  ok_median_incomes.hd01_vd01  AS median_income
FROM 
   ok_tracts
INNER JOIN ok_median_incomes
    ON ok_median_incomes.id = ok_tracts.affgeoid

~~~





http://cse.ssl.berkeley.edu/segwayed/lessons/earthquake_country/5eqcountry.b2abaginfo.html
